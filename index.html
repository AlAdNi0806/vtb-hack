<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Real-time Streaming ASR Frontend</title>
<style>
  #transcript {
    border: 1px solid #ccc;
    padding: 10px;
    min-height: 100px;
    white-space: pre-wrap;
  }
  button {
    padding: 10px 20px;
    font-size: 1.2em;
  }
</style>
</head>
<body>
<h1>Realtime Speech-to-Text</h1>
<button id="startStopBtn">Start Recording</button>
<div id="transcript" placeholder="Transcription appears here..."></div>

<script>
  const startStopBtn = document.getElementById('startStopBtn');
  const transcriptDiv = document.getElementById('transcript');

  let mediaRecorder;
  let socket;
  let recognizing = false;

  startStopBtn.onclick = async () => {
    if (!recognizing) {
      // Start recording
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

      socket = new WebSocket('ws://localhost:8765');

      socket.onopen = () => {
        mediaRecorder.start(250); // send audio chunks every 250ms
        startStopBtn.textContent = 'Stop Recording';
        recognizing = true;
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.transcript) {
          transcriptDiv.textContent = data.transcript;
        }
      };

      socket.onclose = () => {
        mediaRecorder.stop();
        startStopBtn.textContent = 'Start Recording';
        recognizing = false;
      };

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
          event.data.arrayBuffer().then(buffer => {
            socket.send(buffer);
          });
        }
      };

      mediaRecorder.onerror = (event) => {
        console.error("MediaRecorder error:", event.error);
      };

    } else {
      // Stop recording
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
      startStopBtn.textContent = 'Start Recording';
      recognizing = false;
    }
  };
</script>
</body>
</html>
