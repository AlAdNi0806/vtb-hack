<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Real-time Streaming ASR Frontend</title>
<style>
  #transcript {
    border: 1px solid #ccc;
    padding: 10px;
    min-height: 100px;
    white-space: pre-wrap;
  }
  button {
    padding: 10px 20px;
    font-size: 1.2em;
  }
</style>
</head>
<body>
<h1>Realtime Speech-to-Text</h1>
<button id="startStopBtn">Start Recording</button>
<div id="transcript" placeholder="Transcription appears here..."></div>

<script>
const startStopBtn = document.getElementById('startStopBtn');
const transcriptDiv = document.getElementById('transcript');

let audioCtx;
let source;
let processor;
let socket;
let recognizing = false;

startStopBtn.onclick = async () => {
  if (!recognizing) {
    const stream = await navigator.mediaDevices.getUserMedia({audio: true});
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({sampleRate: 16000});
    source = audioCtx.createMediaStreamSource(stream);
    processor = audioCtx.createScriptProcessor(4096, 1, 1); // buffer size 4096
    const ws = new WebSocket('ws://localhost:8765');

    processor.onaudioprocess = e => {
      const channelData = e.inputBuffer.getChannelData(0);
      const pcm16 = new Int16Array(channelData.length);
      for (let i = 0; i < channelData.length; i++) {
        pcm16[i] = Math.max(-1, Math.min(1, channelData[i])) * 0x7FFF;
      }
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(pcm16.buffer);   // raw PCM
      }
    };

    ws.onopen = () => {
      source.connect(processor);
      processor.connect(audioCtx.destination);
      startStopBtn.textContent = 'Stop Recording';
      recognizing = true;
    };

    ws.onmessage = evt => {
      const data = JSON.parse(evt.data);
      transcriptDiv.textContent = data.transcript;
    };

    ws.onclose = () => {
      processor.disconnect();
      source.disconnect();
      if (audioCtx.state !== 'closed') audioCtx.close();
      startStopBtn.textContent = 'Start Recording';
      recognizing = false;
    };

  } else {
    if (processor) processor.disconnect();
    if (source) source.disconnect();
    if (audioCtx) audioCtx.close();
    if (socket && socket.readyState === WebSocket.OPEN) socket.close();
    recognizing = false;
    startStopBtn.textContent = 'Start Recording';
  }
};
</script>
</body>
</html>
